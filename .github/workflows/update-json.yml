name: Update Nyxian AltStore JSON

on:
  schedule:
    - cron: "*/10 * * * *"  # elke 10 minuten
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Get latest Nyxian release
      id: nyx
      run: |
        # Download latest release metadata
        curl -s https://api.github.com/repos/ProjectNyxian/Nyxian/releases/latest > release.json

        URL=$(jq -r '.assets[] | select(.name | endswith(".ipa")) | .browser_download_url' release.json)
        DATE=$(jq -r '.published_at' release.json)
        SIZE=$(curl -sI "$URL" | grep -i Content-Length | awk '{print $2}' | tr -d '\r')
        BODY=$(jq -r '.body' release.json | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')

        echo "URL=$URL" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "SIZE=$SIZE" >> $GITHUB_ENV
        echo "BODY=$BODY" >> $GITHUB_ENV

    - name: Update AltStore JSON
      run: |
        FILE=altstore.json

        # Check if this downloadURL already exists
        if jq -e ".apps[0].versions[] | select(.downloadURL==\"${URL}\")" "$FILE" > /dev/null; then
          echo "Version with this URL already exists"
        else
          echo "Adding new version with URL ${URL}"
          jq ".apps[0].versions += [{
            \"downloadURL\": \"${URL}\",
            \"size\": ${SIZE},
            \"version\": \"1.0\",
            \"date\": \"${DATE}\",
            \"localizedDescription\": \"${BODY}\",
            \"minOSVersion\": null
          }]" "$FILE" > tmp.$$.json && mv tmp.$$.json "$FILE"
        fi

    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Nyxian AltStore JSON for release ${{ env.URL }}"
        commit_user_name: "GitHub Action"
