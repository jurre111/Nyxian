name: Update Nyxian AltStore JSON

on:
  schedule:
    - cron: "*/35 * * * *"  # every 35 minutes
  workflow_dispatch:

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      skip_update: ${{ steps.nyx.outputs.skip_update }}
      url: ${{ steps.nyx.outputs.URL }}
      date: ${{ steps.nyx.outputs.DATE }}
      body: ${{ steps.nyx.outputs.BODY }}
      tag: ${{ steps.nyx.outputs.TAG }}

    steps:
    - uses: actions/checkout@v3

    - name: Get all Nyxian releases
      id: nyx
      run: |
        FILE=source.json

        echo "Fetching all releases..."
        RELEASES_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/ProjectNyxian/Nyxian/releases)

        if [ "$(echo "$RELEASES_JSON" | jq 'type')" != '"array"' ]; then
          echo "Error fetching releases or no releases found."
          exit 1
        fi

        for i in $(seq 0 $(($(echo "$RELEASES_JSON" | jq 'length') - 1))); do
            URL=$(echo "$RELEASES_JSON" | jq -r ".[$i].assets[]? | select(.name | endswith(\".ipa\")) | .browser_download_url")
            
            if [ -n "$URL" ]; then
                TAG=$(echo "$RELEASES_JSON" | jq -r ".[$i].tag_name")
                DATE=$(echo "$RELEASES_JSON" | jq -r ".[$i].published_at")
                
                # Get the raw body text and strip problematic '\r' (carriage return) characters
                BODY_RAW=$(echo "$RELEASES_JSON" | jq -r ".[$i].body" | tr -d '\r')

                echo "Found release $TAG at $URL"

                # Export variables to be used in subsequent steps
                echo "URL=$URL" >> $GITHUB_OUTPUT
                echo "DATE=$DATE" >> $GITHUB_OUTPUT
                echo "TAG=$TAG" >> $GITHUB_OUTPUT

                # Use GitHub's multiline output syntax to preserve newlines correctly
                echo "BODY<<EOF" >> $GITHUB_OUTPUT
                echo "$BODY_RAW" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT

                break
            fi
        done

        if jq -e ".apps[0].versions[] | select(.buildVersion==\"${TAG}\")" "$FILE" > /dev/null; then
          echo "Version with buildVersion ${TAG} already exists. No changes needed."
          echo "SKIP_UPDATE=true" >> $GITHUB_OUTPUT
        else
          echo "Adding new version ${TAG} as the FIRST entry."
          echo "SKIP_UPDATE=false" >> $GITHUB_OUTPUT
        fi

  update:
    runs-on: macos-latest
    needs: check_version
    if: ${{ needs.check_version.outputs.skip_update == 'false' }}
    env:
      URL: ${{ needs.check_version.outputs.url }}
      DATE: ${{ needs.check_version.outputs.date }}
      BODY: ${{ needs.check_version.outputs.body }} # This now receives the raw, multiline string
      TAG: ${{ needs.check_version.outputs.tag }}

    steps:
    - uses: actions/checkout@v3
      with:
        lfs: true 

    - name: Install and Configure Dependenies
      run: |
        brew install git-lfs
        git lfs install
        git lfs track "Resources/App/*.ipa"

    - name: Modify App Package
      run: |
        if [ -z "${{ env.URL }}" ]; then
          echo "No IPA URL found. Skipping IPA modification."
          exit 0
        fi
        
        wget "${{ env.URL }}" -O Nyxian_temp.ipa
        wget https://raw.githubusercontent.com/ProjectNyxian/Nyxian/refs/heads/main/Nyxian/UI/Settings/AppInfo.swift -O AppInfo.swift

        unzip Nyxian_temp.ipa -d Nyxian_extracted
        VERSION=$(sed -nE 's/.*buildVersion: Double = ([0-9.]+).*/\1/p' AppInfo.swift)
        APP_PATH=$(find Nyxian_extracted/Payload -name "*.app" -maxdepth 1)
        PLIST_PATH="${APP_PATH}/Info.plist"

        echo "Modifying version in Info.plist..."
        /usr/bin/plutil -replace CFBundleVersion -string "${{ env.TAG }}" "${PLIST_PATH}"
        /usr/bin/plutil -replace CFBundleShortVersionString -string "${VERSION}" "${PLIST_PATH}"
        
        cd Nyxian_extracted
        zip -r ../Nyxian_modified.ipa Payload
        cd ..

        mkdir -p Resources/App
        cp Nyxian_modified.ipa Resources/App/Nyxian.ipa
        
        SIZE=$(stat -f%z Resources/App/Nyxian.ipa)
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "SIZE=$SIZE" >> $GITHUB_ENV

    - name: Cleanup Temporary Artifacts
      run: |
        echo "Cleaning up large temporary files to prevent Git size violation..."
        rm -rf Nyxian_extracted
        rm -f Nyxian_temp.ipa Nyxian_modified.ipa
        rm -f AppInfo.swift
        
    - name: Update AltStore JSON
      run: |
        FILE=source.json
        FINAL_URL="https://github.com/jurre111/Nyxian/raw/refs/heads/main/Resources/App/Nyxian.ipa" 

        if [ -z "${{ env.TAG }}" ] || [ -z "${{ env.VERSION }}" ] || [ -z "${{ env.SIZE }}" ]; then
          echo "Missing required environment variables (TAG, VERSION, or SIZE). Skipping update."
          exit 1
        fi

        # Use --arg to safely inject all variables.
        # The jq filter now performs two actions:
        # 1. Prepends the new, clean version.
        # 2. Applies a map filter to the existing versions to remove any remaining raw '\r' characters globally.
        jq --arg url "$FINAL_URL" \
           --argjson size "${{ env.SIZE }}" \
           --arg version "${{ env.VERSION }}" \
           --arg tag "${{ env.TAG }}" \
           --arg date "${{ env.DATE }}" \
           --arg body "${{ env.BODY }}" \
           '.apps[0].versions = 
             (
               [{
                 "downloadURL": $url,
                 "size": $size,
                 "version": $version,
                 "buildVersion": $tag,
                 "date": $date,
                 "localizedDescription": $body,
                 "minOSVersion": null
               }]
             ) 
             + 
             (
               .apps[0].versions | 
               map(.localizedDescription |= sub("\r"; ""; "g")) # <-- CLEANUP FILTER APPLIED TO OLD ENTRIES
             )' "$FILE" > tmp.$$.json && mv tmp.$$.json "$FILE"

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Nyxian-IPA
        path: Resources/App/Nyxian.ipa
        
    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Nyxian AltStore JSON and IPA for release ${{ env.TAG }}"
        commit_user_name: "GitHub Action"