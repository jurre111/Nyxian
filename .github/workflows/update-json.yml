name: Update Nyxian AltStore JSON

on:
  schedule:
    - cron: "*/35 * * * *"  # every 35 minutes
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        # We need the source.json file for the early check, but defer LFS setup
        lfs: false 

    - name: Install JSON Processor (jq)
      run: |
        # jq is lightweight and necessary for the early check
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Get latest Nyxian release info
      id: nyx
      run: |
        echo "Fetching all releases..."
        RELEASES_FILE="releases.json"

        # Note: Using an authenticated request (via GITHUB_TOKEN) is better for rate limits
        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/ProjectNyxian/Nyxian/releases > "$RELEASES_FILE"

        if [ "$(jq 'type' "$RELEASES_FILE")" != '"array"' ]; then
          echo "Error fetching releases or no releases found."
          exit 1
        fi
        
        # Find the latest release that contains an .ipa asset
        RELEASE_INFO=$(jq -r '.[] | select(.assets[]? | .name | endswith(".ipa"))' "$RELEASES_FILE" | head -n 1)

        if [ -z "$RELEASE_INFO" ]; then
            echo "No releases with an IPA asset found."
            exit 0
        fi

        # Extract required information from the latest release
        URL=$(echo "$RELEASE_INFO" | jq -r ".assets[] | select(.name | endswith(\".ipa\")) | .browser_download_url" | head -n 1)
        TAG=$(echo "$RELEASE_INFO" | jq -r ".tag_name")
        DATE=$(echo "$RELEASE_INFO" | jq -r ".published_at")
        
        # Format the release body for safe JSON insertion
        BODY=$(echo "$RELEASE_INFO" | jq -r ".body" | sed -e ':a;N;$!ba;s/\n/\\n/g' -e 's/"/\\"/g')

        echo "Found latest release $TAG at $URL"

        # Export variables
        echo "URL=$URL" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "BODY=$BODY" >> $GITHUB_ENV
        echo "TAG=$TAG" >> $GITHUB_ENV

    ---

    ## ðŸš€ Early Exit Check

    - name: Check if version already exists (EARLY EXIT)
      run: |
        FILE=source.json
        TAG="${{ env.TAG }}"
        
        if [ -z "$TAG" ]; then
          echo "No TAG found. Exiting."
          exit 0
        fi

        # Check if a version with the same buildVersion (TAG) exists in the JSON
        if jq -e ".apps[0].versions[] | select(.buildVersion==\"${TAG}\")" "$FILE" > /dev/null; then
          echo "Version with buildVersion ${TAG} already exists. Stopping workflow to avoid unnecessary processing."
          # Use a specific non-zero exit code (78) to signal a controlled skip/cancellation
          exit 78 
        else
          echo "New version ${TAG} found. Proceeding with full update."
        fi

    ---

    ## ðŸ› ï¸ Full Update (Only runs if new version is detected)

    - name: Configure Git LFS and Install plist-utils
      run: |
        # Install git-lfs and plist-utils now, only if a new version needs processing
        sudo apt-get update
        sudo apt-get install -y git-lfs libplist-utils

        # Initialize LFS in the repository
        git lfs install
        # Tell Git to track the large IPA file
        git lfs track "Resources/App/*.ipa"
        
        # We need to explicitly check out LFS files now that LFS is configured
        git lfs pull || echo "No LFS files to pull or error pulling LFS files."


    - name: Modify App Package
      run: |
        # ... (rest of the steps remain the same) ...
        if [ -z "${{ env.URL }}" ]; then
          echo "No IPA URL found. Skipping IPA modification."
          exit 0
        fi

        # 1. Download original IPA (using a unique temporary name)
        wget "${{ env.URL }}" -O Nyxian_temp.ipa
        
        # 2. Download source file
        wget https://raw.githubusercontent.com/ProjectNyxian/Nyxian/refs/heads/main/Nyxian/UI/Settings/AppInfo.swift -O AppInfo.swift

        # 3. Unzip and modify plist
        unzip Nyxian_temp.ipa -d Nyxian_extracted
        VERSION=$(grep "buildVersion" AppInfo.swift | sed -E 's/.*buildVersion: Double = ([0-9.]+).*/\1/')
        APP_PATH=$(find Nyxian_extracted/Payload -name "*.app" -maxdepth 1)
        PLIST_PATH="${APP_PATH}/Info.plist"

        if [ -z "$VERSION" ]; then
            echo "Warning: Could not extract VERSION from AppInfo.swift. Using TAG as fallback."
            VERSION="${{ env.TAG }}"
        fi

        plistutil -replace CFBundleVersion -string "${{ env.TAG }}" "${PLIST_PATH}"
        plistutil -replace CFBundleShortVersionString -string "${VERSION}" "${PLIST_PATH}"
        
        # 4. Re-package the modified IPA using a temporary name
        zip -r Nyxian_modified.ipa Nyxian_extracted/*

        # 5. Create the target directory structure
        mkdir -p Resources/App
        
        # 6. Copy the modified IPA to the final destination
        cp Nyxian_modified.ipa Resources/App/Nyxian.ipa

        # 7. Calculate size of the final, committed file (in bytes)
        SIZE=$(stat -c%s Resources/App/Nyxian.ipa)
        
        # 8. Export variables
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "SIZE=$SIZE" >> $GITHUB_ENV

    - name: Cleanup Temporary Artifacts
      run: |
        echo "Cleaning up large temporary files to prevent Git size violation..."
        rm -rf Nyxian_extracted
        rm -f Nyxian_temp.ipa Nyxian_modified.ipa
        rm -f AppInfo.swift


    - name: Update AltStore JSON
      run: |
        FILE=source.json

        URL="https://github.com/jurre111/Nyxian/raw/refs/heads/main/Resources/App/Nyxian.ipa" 
        TAG="${{ env.TAG }}"
        VERSION="${{ env.VERSION }}"
        SIZE="${{ env.SIZE }}" 
        DATE="${{ env.DATE }}"
        BODY="${{ env.BODY }}"

        echo "Adding new version ${TAG} as the FIRST entry."
          
        # Prepend the new version object to the existing versions array
        jq ".apps[0].versions = [{
          \"downloadURL\": \"${URL}\",
          \"size\": ${SIZE},
          \"version\": \"${VERSION}\",
          \"buildVersion\": \"${TAG}\",
          \"date\": \"${DATE}\",
          \"localizedDescription\": \"${BODY}\",
          \"minOSVersion\": null
        }] + .apps[0].versions" "$FILE" > tmp.$$.json && mv tmp.$$.json "$FILE"

    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Update Nyxian AltStore JSON and IPA for release ${{ env.TAG }}"
        commit_user_name: "GitHub Action"